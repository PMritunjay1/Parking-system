<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>
        Login - Parking Management
    </title>
    <link rel="icon" type="image/png" href="logo.png">
    <!-- Google Font: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome 6 -->
    <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        referrerpolicy="no-referrer" rel="stylesheet">
    <!-- Global Theme CSS -->
    <link href="style.css" rel="stylesheet" />
    <!-- Page-specific CSS -->
    <link href="login_page.css" rel="stylesheet" />
    <!-- Common Auth Header/Footer styles (as provided) -->
    <style>
        .auth-navbar {
            background-color: #03011d;
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .auth-navbar .navbar-brand span {
            color: #fff;
        }

        .auth-footer {
            background: #03011d;
            color: #cfd3d7;
        }

        .auth-footer a {
            color: #cfd3d7;
            text-decoration: none;
        }

        .auth-footer a:hover {
            color: #ffffff;
            text-decoration: underline;
        }
    </style>
    </link>
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Common Auth Header (Login Page) -->
    <nav class="navbar navbar-expand auth-navbar navbar-dark px-3">
        <a class="navbar-brand d-flex align-items-center gap-2" href="./index.html">
            <img alt="Logo" onerror="this.onerror=null;" src="logo.png" style="height:32px;" />
            <span>
                Parking Management
            </span>
        </a>
        <div class="ms-auto d-flex align-items-center gap-3">
            <a class="text-decoration-none text-light" href="#" data-bs-toggle="modal" data-bs-target="#contactModal">
                <i class="fa-solid fa-circle-question me-1">
                </i>
                Help
            </a>
        </div>
    </nav>
    <main class="flex-grow-1">
        <div class="bg-muted border-bottom">

            <nav aria-label="breadcrumb" class="container-max pill-nav mb-0 d-none d-md-flex">
                <span class="breadcrumb-item">
                    <a href="./entry_gate.html">Entry Gate</a>
                </span>
                <span class="breadcrumb-item">
                    <a href="./exit_gate.html">Exit Gate</a>
                </span>
                <span class="breadcrumb-item">
                    <a href="./index.html" class="active">Login</a>
                </span>
                <span class="breadcrumb-item">
                    <a href="./index.html">Admin</a>
                </span>
                <span class="breadcrumb-item">
                    <a href="./index.html">Records</a>
                </span>
                <span class="breadcrumb-item">
                    <a href="./index.html">Reports</a>
                </span>
            </nav>

            <div class="dropdown d-md-none p-2">
                <button class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="fa-solid fa-bars me-2"></i> Quick Navigation
                </button>
                <ul class="dropdown-menu w-100">
                    <li><a class="dropdown-item" href="./entry_gate.html">Entry Gate</a></li>
                    <li><a class="dropdown-item" href="./exit_gate.html">Exit Gate</a></li>
                    <li><a class="dropdown-item" href="./index.html">Login</a></li>
                    <li><a class="dropdown-item" href="./index.html">Admin</a></li>
                    <li><a class="dropdown-item" href="./index.html">Records</a></li>
                    <li><a class="dropdown-item" href="./index.html">Reports</a></li>
                </ul>
            </div>

        </div>
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8 col-xl-6">
                    <div class="login-form-container">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <img alt="Parking Logo" class="rounded" onerror="this.onerror=null;" src="logo.png"
                                style="height:40px;" />
                            <div>
                                <h1 class="h4 mb-0">
                                    Admin Panel Login
                                </h1>
                                <small class="text-muted">
                                    Secure access for Administrators, Attendants, and Management
                                </small>
                            </div>
                        </div>
                        <!-- FeedbackDisplay: Hidden by default -->
                        <div class="alert alert-danger d-none" id="errorAlert" role="alert">
                            <i class="fa-solid fa-triangle-exclamation me-2">
                            </i>
                            <span id="errorText">
                                Invalid username or password. Please try again.
                            </span>
                        </div>
                        <!-- LoginForm -->
                        <form id="loginForm" novalidate="">
                            <!-- CredentialInputs -->
                            <div class="mb-3">
                                <label class="form-label" for="username">
                                    Username / Email
                                </label>
                                <input aria-describedby="usernameHelp" class="form-control" id="username"
                                    name="username" placeholder="Enter your username or email" required=""
                                    type="text" />
                                <div class="invalid-feedback">
                                    Please enter your username or email.
                                </div>
                            </div>
                            <div class="mb-2 position-relative">
                                <label class="form-label" for="password">
                                    Password
                                </label>
                                <input class="form-control pe-5" id="password" name="password"
                                    placeholder="Enter your password" required="" type="password" />
                                <i aria-label="Toggle password visibility"
                                    class="fa-regular fa-eye toggle-visibility-icon" id="togglePassword" role="button">
                                </i>
                                <div class="invalid-feedback">
                                    Please enter your password.
                                </div>
                            </div>
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" id="rememberMe" type="checkbox" value="1" />
                                    <label class="form-check-label" for="rememberMe">
                                        Remember me
                                    </label>
                                </div>
                                <a class="small text-decoration-none" href="#">
                                    Forgot password?
                                </a>
                            </div>
                            <!-- LoginAction -->
                            <div class="d-grid">
                                <button class="btn btn-primary btn-lg" id="loginBtn" type="submit">
                                    <span aria-hidden="true" class="spinner-border spinner-border-sm me-2 d-none"
                                        id="btnSpinner" role="status">
                                    </span>
                                    <i class="fa-solid fa-right-to-bracket me-2">
                                    </i>
                                    Login
                                </button>
                            </div>
                            <div class="mt-3 small text-muted">
                                By continuing you agree to our
                                <a href="#terms">
                                    Terms
                                </a>
                                and
                                <a href="#privacy">
                                    Privacy Policy
                                </a>
                                .
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Test Accounts / Quick Start -->
            <div class="row justify-content-center mt-4">
                <div class="col-12 col-lg-10">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-plug-circle-check me-2 text-success">
                                </i>
                                <strong>
                                    Test Accounts
                                </strong>
                            </div>
                            <small class="text-muted">
                                Use the following credentials to test role-based access and redirections.
                            </small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-theme mb-0">
                                    <thead>
                                        <tr>
                                            <th>Role</th>
                                            <th>Username</th>
                                            <th>Password</th>
                                            <th>Redirects To</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Administrator</td>
                                            <td><code>admin</code>or<code>admin@mall.com</code></td>
                                            <td><code>admin123</code></td>
                                            <td>
                                                <span class="badge-soft info">
                                                    ./admin_dashboard.html
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Attendant (Entry)</td>
                                            <td><code>attendant1</code></td>
                                            <td><code>attendant123</code></td>
                                            <td><span class="badge-soft info">./entry_gate.html</span></td>
                                        </tr>
                                        <tr>
                                            <td>Attendant (Exit)</td>
                                            <td><code>attendant2</code></td>
                                            <td><code>attendant123</code></td>
                                            <td><span class="badge-soft info">./exit_gate.html</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Manager</td>
                                            <td><code>manager</code>or<code>manager@mall.com</code></td>
                                            <td><code>manager123</code></td>
                                            <td>
                                                <span class="badge-soft info">
                                                    ./reports_page.html
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Records Officer</td>
                                            <td><code>records</code></td>
                                            <td><code>records123</code></td>
                                            <td><span class="badge-soft info">
                                                    ./records_search.html
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer small text-muted">
                            Note: These are demo credentials for testing only. In production, authentication is handled
                            securely via the backend API.
                        </div>
                    </div>
                </div>
            </div>
            <!-- Help Section Anchor -->
            <div class="row justify-content-center mt-4" id="help">
                <div class="col-12 col-lg-10">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fa-solid fa-circle-info me-2">
                        </i>
                        <div>
                            For access issues, contact IT Support at
                            <a href="mailto:support@parking.example">
                                support@parking.example
                            </a>
                            or refer to the documentation provided.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Common Auth Footer (Login Page) -->
    <footer class="auth-footer mt-auto py-3 px-3">
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 st">
            <div class="d-flex align-items-center gap-2">
                <img alt="Logo" onerror="this.onerror=null;" src="logo.png" style="height:20px;" />
                <small>
                    Â© 2025 Parking System
                </small>
            </div>
            <div class="d-flex align-items-center gap-3 small">
                <a href="#terms">
                    Terms
                </a>
                <a href="#privacy">
                    Privacy
                </a>
                <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal"
                    data-bs-target="#contactModal">
                    <i class="fa-solid fa-envelope me-1"></i> Contact Us
                </button>
            </div>
        </div>
    </footer>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    </script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
    </script>
    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';

        const form = document.getElementById('loginForm');
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const errorAlert = document.getElementById('errorAlert');
        const errorText = document.getElementById('errorText');
        const btn = document.getElementById('loginBtn');
        const spinner = document.getElementById('btnSpinner');
        const togglePassword = document.getElementById('togglePassword');

        // Toggle password visibility
        togglePassword.addEventListener('click', () => {
            const isPwd = passwordEl.getAttribute('type') === 'password';
            passwordEl.setAttribute('type', isPwd ? 'text' : 'password');
            togglePassword.classList.toggle('fa-eye');
            togglePassword.classList.toggle('fa-eye-slash');
            togglePassword.setAttribute('aria-pressed', isPwd ? 'true' : 'false');
        });

        // Helper: UI Loading state
        function setLoading(isLoading) {
            if (isLoading) {
                spinner.classList.remove('d-none');
                btn.setAttribute('disabled', 'disabled');
                usernameEl.setAttribute('disabled', 'disabled');
                passwordEl.setAttribute('disabled', 'disabled');
            } else {
                spinner.classList.add('d-none');
                btn.removeAttribute('disabled');
                usernameEl.removeAttribute('disabled');
                passwordEl.removeAttribute('disabled');
            }
        }

        // Validate required fields
        function validate() {
            let valid = true;
            if (!usernameEl.value.trim()) {
                usernameEl.classList.add('is-invalid');
                valid = false;
            } else {
                usernameEl.classList.remove('is-invalid');
            }
            if (!passwordEl.value.trim()) {
                passwordEl.classList.add('is-invalid');
                valid = false;
            } else {
                passwordEl.classList.remove('is-invalid');
            }
            return valid;
        }

        // Hide inline error if user edits
        [usernameEl, passwordEl].forEach(el => {
            el.addEventListener('input', () => {
                el.classList.remove('is-invalid');
                errorAlert.classList.add('d-none');
            });
        });

        // Form submit logic
        // REPLACE your entire form 'submit' event listener with this

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorAlert.classList.add('d-none');

            if (!validate()) {
                errorText.textContent = 'Please fill in both fields.';
                errorAlert.classList.remove('d-none');
                return;
            }

            const username = usernameEl.value.trim();
            const password = passwordEl.value;

            setLoading(true);

            try {
                // Your FastAPI backend expects form data, not JSON, for login.
                // We create it using URLSearchParams.
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                // Make the real API call to the /auth/login endpoint
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    // If login fails (e.g., 401 Unauthorized), handle the error
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Incorrect username or password');
                }

                const authData = await response.json();

                // On success, save the access token to localStorage
                localStorage.setItem('accessToken', authData.access_token);
                localStorage.setItem('userRole', authData.user_role);

                // Define where to redirect based on the role from the API
                const redirectMap = {
                    'Administrator': './admin_dashboard.html',
                    'Attendant': './entry_gate.html', // Or a specific attendant dashboard
                    // Add other roles and their pages here
                };
                const redirectUrl = redirectMap[authData.user_role] || './admin_dashboard.html';

                Swal.fire({
                    title: 'Welcome',
                    text: `${authData.user_role} authenticated successfully. Redirecting...`,
                    icon: 'success',
                    timer: 1400,
                    showConfirmButton: false
                });

                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1200);

            } catch (error) {
                errorText.textContent = error.message;
                errorAlert.classList.remove('d-none');
                Swal.fire({
                    title: 'Login Failed',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: 'Retry'
                });
                setLoading(false);
            }
        });// This script should be placed in a <script> tag on pages where the modal exists
        document.addEventListener('DOMContentLoaded', function () {
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            if (sendMessageBtn) {
                sendMessageBtn.addEventListener('click', function () {
                    // In a real app, you would gather form data and send it to your server here.
                    // Example: const name = document.getElementById('contactName').value;

                    // For now, we'll just show a success message.
                    Swal.fire({
                        icon: 'success',
                        title: 'Message Sent!',
                        text: 'Thank you for contacting us. We will get back to you shortly.',
                        timer: 2500,
                        showConfirmButton: false
                    });

                    // Close the modal
                    const contactModal = document.getElementById('contactModal');
                    const modal = bootstrap.Modal.getInstance(contactModal);
                    if (modal) {
                        modal.hide();
                    }
                });
            }
        });
    </script>
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel"><i class="fa-solid fa-paper-plane me-2"></i>Contact
                        Support</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">If you have any questions or need assistance, please fill out the form
                        below. Our team will get back to you shortly.</p>
                    <form id="contactForm">
                        <div class="mb-3">
                            <label for="contactName" class="form-label">Your Name</label>
                            <input type="text" class="form-control" id="contactName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Your Email</label>
                            <input type="email" class="form-control" id="contactEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="contactMessage" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="sendMessageBtn">Send Message</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>