<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>
        Report - Parking Management
    </title>
    <link rel="icon" type="image/png" href="logo.png">
    <!-- Brand typography: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome 6 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <!-- Flatpickr (date/week picker) -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.min.css" rel="stylesheet" />
    <!-- Global Theme CSS -->
    <link href="style.css" rel="stylesheet" />
    <!-- Page-specific CSS -->
    <link href="reports_page.css" rel="stylesheet" />
    <script>
        (function () {
            const token = localStorage.getItem('accessToken');
            if (!token) {

                window.location.replace('./index.html');
            }
        })();
    </script>
</head>

<body class="min-vh-100 d-flex flex-column bg-muted border-bottom">
    <!-- Header (Common Component: needed on Reports Page) -->
    <nav class="navbar navbar-dark manager-navbar px-3">
        <div class="dropdown d-xl-none p-2">
            <button class="btn btn-outline-light me-2 d-lg-none " data-bs-target="#managerNav" data-bs-toggle="dropdown"
                type="button">
                <i class="fa-solid fa-bars">
                </i>
            </button>
            <ul class="dropdown-menu ex w-100">
                <li><a class="dropdown-item" href="./admin_dashboard.html"><i class="fa-solid fa-gauge-high me-2">
                        </i>KPI Dashboard</a></li>
                <li><a class="dropdown-item" href="./reports_page.html"><i class="fa-solid fa-chart-line me-2">
                        </i>Weekly Report</a></li>
                <li><a class="dropdown-item" href="#revenue"><i class="fa-solid fa-coins me-2">
                        </i>Revenue by Lot</a></li>
                <li><a class="dropdown-item" href="#occupancy"><i class="fa-solid fa-chart-area me-2">
                        </i>Occupancy Trends</a></li>
                <li><a class="dropdown-item" href="#penalties"><i class="fa-solid fa-ticket me-2">
                        </i>Penalties Overview</a></li>
                <li><a class="dropdown-item" href="#settings"><i class="fa-solid fa-user-gear me-2">
                        </i>Profile &amp; Settings</a></li>
            </ul>
        </div>

        <a class="navbar-brand d-flex align-items-center gap-2" href="admin_dashboard.html">
            <img alt="Logo" onerror="this.onerror=null;"
                src="logo.png"                
                style="height:28px;" />
            <span>
                Management
            </span>
        </a>
        
        <div class="ms-auto d-flex align-items-center gap-2">
            <div class="dropdown me-2">
                <button class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fa-solid fa-calendar-week me-1">
                    </i>
                    Select Week
                </button>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                    <li>
                        <a class="dropdown-item js-quick-week" data-range="this">
                            This Week
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item js-quick-week" data-range="last">
                            Last Week
                        </a>
                    </li>
                </ul>
            </div>
            <a class="btn btn-sm export-btn" href="#export" id="btnHeaderExport">
                <i class="fa-solid fa-file-pdf me-1">
                </i>
                Export PDF
            </a>
            <div class="dropdown">
                <a class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fa-solid fa-user-tie me-1">
                    </i>
                    Mritunjay
                </a>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                    <li>
                        <a class="dropdown-item" href="#settings">
                            <i class="fa-solid fa-user-gear me-2">
                            </i>
                            Settings
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider" />
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="logoutButton">
                            <i class="fa-solid fa-right-from-bracket me-2"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Main layout: Sidebar + Content -->
    <div class="flex-grow-1 d-flex">
        <!-- Sidebar (Common Component: needed on Reports Page) -->
        <aside class="d-none d-lg-flex flex-column vh-100 p-3" id="sidebarManager">
            <div class="d-flex align-items-center justify-content-between brand-area mb-3">
                <div class="d-flex align-items-center gap-2">
                    <img alt="Logo" onerror="this.onerror=null;"
                        src="manag.jpg"
                        style=" border-radius: 50%;  width: 45px;  height: 45px; object-fit: cover;" />
                    <span class="fw-semibold">
                        Management
                    </span>
                </div>
                <button class="btn btn-outline-light me-2 d-lg-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#sidebarManagerOffcanvas" aria-controls="sidebarManagerOffcanvas">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>


            <div class="profile d-flex align-items-center gap-2 p-2 mb-3">
                <img alt="avatar" class="rounded-circle"
                    onerror="this.onerror=null;this.src='https://picsum.photos/seed/manager/72/72';"
                    src="https://ui-avatars.com/api/?name=Manager&amp;background=194542&amp;color=fff"
                    style="width:36px;height:36px;" />
                <div>
                    <div class="fw-semibold">
                        Mritunjay Pandey
                    </div>
                    <small class="text-muted">
                        Manager
                    </small>
                </div>
            </div>
            <nav class="nav flex-column collapse show" id="managerNav">
                <a class="nav-link" href="./admin_dashboard.html">
                    <i class="fa-solid fa-gauge-high me-2">
                    </i>
                    KPIs Dashboard
                </a>
                <a class="nav-link active" href="./reports_page.html">
                    <i class="fa-solid fa-chart-line me-2">
                    </i>
                    Weekly Reports
                </a>
                <a class="nav-link" href="#revenue">
                    <i class="fa-solid fa-coins me-2">
                    </i>
                    Revenue by Lot
                </a>
                <a class="nav-link" href="#occupancy">
                    <i class="fa-solid fa-chart-area me-2">
                    </i>
                    Occupancy Trends
                </a>
                <a class="nav-link" href="#penalties">
                    <i class="fa-solid fa-ticket me-2">
                    </i>
                    Penalties Overview
                </a>
                <hr class="border-secondary" />
                <a class="nav-link" href="#settings">
                    <i class="fa-solid fa-user-gear me-2">
                    </i>
                    Profile &amp; Settings
                </a>
            </nav>

        </aside>
        <!-- Main content area -->
        <main class="flex-grow-1">
            <div class="container-fluid p-3 p-md-4">
                <!-- Breadcrumbs and page header -->
                <div class="bg-muted border-bottom">

                    <nav aria-label="breadcrumb" class="container-max pill-nav mb-0 d-none d-md-flex">
                        <span class="breadcrumb-item">
                            <a href="./entry_gate.html">Entry Gate</a>
                        </span>
                        <span class="breadcrumb-item">
                            <a href="./exit_gate.html">Exit Gate</a>
                        </span>
                        <span class="breadcrumb-item">
                            <a href="./index.html">Login</a>
                        </span>
                        <span class="breadcrumb-item">
                            <a href="./admin_dashboard.html">Admin</a>
                        </span>
                        <span class="breadcrumb-item">
                            <a href="./records_search.html">Records</a>
                        </span>
                        <span class="breadcrumb-item">
                            <a href="./reports_page.html" class="active">Reports</a>
                        </span>
                    </nav>

                    <div class="dropdown d-md-none p-2">
                        <button class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="fa-solid fa-bars me-2"></i> Quick Navigation
                        </button>
                        <ul class="dropdown-menu w-100">
                            <li><a class="dropdown-item" href="./entry_gate.html">Entry Gate</a></li>
                            <li><a class="dropdown-item" href="./exit_gate.html">Exit Gate</a></li>
                            <li><a class="dropdown-item" href="./index.html">Login</a></li>
                            <li><a class="dropdown-item" href="./admin_dashboard.html">Admin</a></li>
                            <li><a class="dropdown-item" href="./records_search.html">Records</a></li>
                            <li><a class="dropdown-item" href="./reports_page.html">Reports</a></li>
                        </ul>
                    </div>

                </div>
                <div class="page-header">
                    <div>

                        <h1 class="page-title">
                            Weekly Reports
                        </h1>
                        <small class="text-muted">
                            Generate, review, and export weekly revenue and occupancy insights
                        </small>
                    </div>
                    <div class="reveal-on-hover">
                        <div class="view-switcher">
                            <span class="option active">
                                <i class="fa-solid fa-table">
                                </i>
                            </span>
                            <span class="option">
                                <i class="fa-solid fa-grip">
                                </i>
                            </span>
                        </div>
                    </div>
                </div>
                <!-- System Feedback Toasts -->
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
                    <div aria-atomic="true" aria-live="assertive"
                        class="toast align-items-center text-bg-primary border-0" id="toastArea" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fa-solid fa-circle-check me-2">
                                </i>
                                Report generated successfully.
                            </div>
                            <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto"
                                data-bs-dismiss="toast" type="button">
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Report Filters -->
                <section class="app-card mb-4">
                    <div class="card-header">
                        <div class="title d-flex align-items-center gap-2">
                            <i class="fa-solid fa-filter">
                            </i>
                            <span class="widget-title">
                                Report Filters
                            </span>
                        </div>
                        <div class="text-muted small">
                            Select report type and week, then click Generate
                        </div>
                    </div>
                    <div class="card-body">
                        <form class="row g-3 align-items-end" id="reportFilters">
                            <div class="col-sm-6 col-md-4">
                                <label class="form-label" for="reportType">
                                    Report Type
                                </label>
                                <select class="form-select" id="reportType" required="">
                                    <option disabled="" selected="" value="">
                                        Select type
                                    </option>
                                    <option>
                                        Weekly Revenue
                                    </option>
                                    <option>
                                        Weekly Occupancy
                                    </option>
                                </select>
                            </div>
                            <div class="col-sm-6 col-md-4">
                                <label class="form-label" for="weekPicker">
                                    Select Week
                                </label>
                                <input autocomplete="off" class="form-control" id="weekPicker"
                                    placeholder="Pick a week" />
                                <div class="form-text">
                                    Past weeks only
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-4 d-flex gap-2">
                                <button class="btn btn-primary flex-grow-1" disabled="" id="btnGenerate" type="button">
                                    <span class="me-1">
                                        <i class="fa-solid fa-gear">
                                        </i>
                                    </span>
                                    <span class="btn-text">
                                        Generate Report
                                    </span>
                                    <span aria-hidden="true" class="spinner-border spinner-border-sm ms-2 d-none"
                                        id="genSpinner" role="status">
                                    </span>
                                </button>
                                <button class="btn btn-light" id="btnReset" title="Reset filters" type="button">
                                    <i class="fa-solid fa-rotate">
                                    </i>
                                </button>
                            </div>
                        </form>
                    </div>
                </section>
                <!-- Report Display Area -->
                <section id="reportArea">


                </section>
                <section class="grid gap-3" id="reportArea">
                    <!-- Empty State (shown initially) -->
                    <div class="empty-state" id="emptyState">
                        <img alt="placeholder" class="mb-2 rounded" src="image.png">
                        <h5 class="text-strong">
                            No report generated yet
                        </h5>
                        <p class="empty-state-text">
                            Select a report type and week, then click Generate Report to view insights here.
                        </p>
                        <button class="btn btn-secondary" onclick="document.getElementById('reportType').focus()"
                            type="button">
                            <i class="fa-solid fa-arrow-turn-down me-1">
                            </i>
                            Get Started
                        </button>
                        </img>
                    </div>
                    <!-- Loading State -->
                    <div class="loading-state d-none" id="loadingState">
                        <div class="w-100">
                            <div class="skeleton mb-3" style="height:20px;width:60%">
                            </div>
                            <div class="grid auto-fit-md">
                                <div class="skeleton" style="height:100px">
                                </div>
                                <div class="skeleton" style="height:100px">
                                </div>
                                <div class="skeleton" style="height:100px">
                                </div>
                            </div>
                            <div class="skeleton mt-4" style="height:280px">
                            </div>
                            <div class="skeleton mt-3" style="height:280px">
                            </div>
                        </div>
                    </div>
                    <!-- Report Content (shown after generation) -->
                    <div class="d-none" id="reportContent">
                        <!-- Report header with export -->
                        <div class="app-card mb-3">
                            <div class="card-header">
                                <div>
                                    <div class="widget-title" id="reportTitle">
                                        Weekly Report
                                    </div>
                                    <small class="text-muted" id="reportSubtitle">
                                        —
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-info" disabled="" id="btnExport">
                                        <i class="fa-solid fa-file-arrow-down me-1">
                                        </i>
                                        Export to PDF
                                    </button>
                                </div>
                            </div>
                            <div class="card-body py-3">
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <span class="badge-soft info">
                                        <i class="fa-solid fa-calendar-week me-1">
                                        </i>
                                        <span id="badgeWeek">
                                            Week
                                        </span>
                                    </span>
                                    <span class="badge-soft primary" id="badgeType">
                                        <i class="fa-solid fa-layer-group me-1">
                                        </i>
                                        Type
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Key Metrics Summary -->
                        <div class="grid auto-fit-lg" id="metricsRow">
                            <!-- Metrics will be injected -->
                        </div>
                        <!-- Chart Card -->
                        <div id="revenue" class="app-card mt-3">
                            <div class="card-header">
                                <div class="title d-flex align-items-center gap-2">
                                    <i class="fa-solid fa-chart-column">
                                    </i>
                                    <span class="widget-title" id="chartTitle">
                                        Report Chart
                                    </span>
                                </div>
                                <div class="text-muted small" id="chartSubtitle">
                                    Interactive chart with tooltips and zoom
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-wrap">
                                    <canvas aria-label="Report Chart" height="140" id="reportChart" role="img">
                                    </canvas>
                                </div>
                            </div>
                        </div>
                        <section id="penalties" class="report-section d-none mt-3">
                            <div class="app-card">
                                <div class="card-header">
                                    <h5 class="widget-title mb-0"><i class="fa-solid fa-ticket me-2"></i>Penalties
                                        Overview</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-2">Total amount collected from penalties (e.g., lost
                                        tickets) in the selected period.</p>
                                    <div class="metric-card simple">
                                        <div class="metric-title">Revenue from Penalties</div>
                                        <div class="metric-value" id="penaltiesTotalAmount">--</div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <!-- Table Controls -->
                        <div class="d-flex align-items-center justify-content-between mt-4 mb-2 gap-2 flex-wrap">
                            <div class="d-flex align-items-center gap-2">
                                <div class="input-group input-group-sm" style="max-width: 260px;">
                                    <span class="input-group-text">
                                        <i class="fa-solid fa-magnifying-glass">
                                        </i>
                                    </span>
                                    <input class="form-control" id="tableSearch" placeholder="Filter table..."
                                        type="text" />
                                </div>
                                <div class="form-text">
                                    Click headers to sort
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <label class="small text-muted">
                                    Rows per page
                                </label>
                                <select class="form-select form-select-sm" id="rowsPerPage" style="width:90px;">
                                    <option>
                                        5
                                    </option>
                                    <option selected="">
                                        10
                                    </option>
                                    <option>
                                        20
                                    </option>
                                </select>
                            </div>
                        </div>
                        <!-- Detailed Report Table -->
                        <div class="app-card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-theme mb-0" id="reportTable">
                                        <thead id="tableHead">
                                            <!-- Dynamic columns -->
                                        </thead>
                                        <tbody id="tableBody">
                                            <!-- Dynamic rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <div class="small text-muted" id="paginationInfo">
                                    Showing 0 to 0 of 0 entries
                                </div>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0" id="pagination">
                                        <!-- Pagination items injected -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Secondary navigation links (site pages) -->
                <div class="mt-4">
                    <div class="auxiliary-links small">
                        <a href="./entry_gate.html">
                            <i class="fa-solid fa-door-open me-1">
                            </i>
                            Entry Gate
                        </a>
                        <a href="./exit_gate.html">
                            <i class="fa-solid fa-door-closed me-1">
                            </i>
                            Exit Gate
                        </a>
                        <a href="./records_search.html">
                            <i class="fa-solid fa-magnifying-glass me-1">
                            </i>
                            Records Search
                        </a>
                        <a href="./admin_dashboard.html">
                            <i class="fa-solid fa-gauge-high me-1">
                            </i>
                            Admin Dashboard
                        </a>
                        <a class="text-strong" href="./reports_page.html">
                            <i class="fa-solid fa-chart-line me-1">
                            </i>
                            Reports Page
                        </a>
                        <a href="./index.html">
                            <i class="fa-solid fa-right-to-bracket me-1">
                            </i>
                            Login
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Footer (Common Component: needed on Reports Page) -->
    <footer class="manager-footer mt-auto py-2 px-3">
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-3 small">
                <a href="/admin/dashboard">
                    <i class="fa-solid fa-gauge-high me-1">
                    </i>
                    KPIs
                </a>
                <a href="/admin/reports">
                    <i class="fa-solid fa-chart-line me-1">
                    </i>
                    Reports
                </a>
                <a href="#export" id="footerExport">
                    <i class="fa-solid fa-file-pdf me-1">
                    </i>
                    Export
                </a>
            </div>
            <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal"
                data-bs-target="#contactModal">
                <i class="fa-solid fa-envelope me-1"></i> Contact Us
            </button>
            <div class="d-flex align-items-center gap-3 small">
                <a href="#terms">
                    Terms
                </a>
                <a href="#privacy">
                    Privacy
                </a>
                <span class="text-muted">
                    © 2025 Parking System
                </span>
            </div>
        </div>
    </footer>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js">
    </script>
    <script>
        // At the top of your <script> tag
        const API_BASE_URL = 'http://127.0.0.1:8000';

        /**
         * A helper function to make authenticated API calls.
         * It automatically gets the token from localStorage and adds it to the header.
         */
        async function fetchWithAuth(endpoint, options = {}) {
            const token = localStorage.getItem('accessToken');

            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });

            if (!response.ok) {
                if (response.status === 401) { // Unauthorized
                    window.location.href = './index.html'; // Redirect to login
                }
                const error = new Error(`API request failed with status ${response.status}`);
                error.status = response.status; // Attach the status code to the error
                throw error;
            }

            return response.json();
        }
        // State
        const state = {
            selectedReportType: '',
            selectedWeek: null, // { start: Date, end: Date }
            isLoading: false,
            isReportGenerated: false,
            reportData: null,
            chart: null,
            table: {
                columns: [],
                rows: [],
                filteredRows: [],
                sortKey: '',
                sortDir: 'asc',
                page: 1,
                rowsPerPage: 10
            }
        };

        // Elements
        const el = {
            reportType: document.getElementById('reportType'),
            weekPicker: document.getElementById('weekPicker'),
            btnGenerate: document.getElementById('btnGenerate'),
            btnReset: document.getElementById('btnReset'),
            genSpinner: document.getElementById('genSpinner'),
            emptyState: document.getElementById('emptyState'),
            loadingState: document.getElementById('loadingState'),
            reportContent: document.getElementById('reportContent'),
            reportTitle: document.getElementById('reportTitle'),
            reportSubtitle: document.getElementById('reportSubtitle'),
            badgeWeek: document.getElementById('badgeWeek'),
            badgeType: document.getElementById('badgeType'),
            btnExport: document.getElementById('btnExport'),
            btnHeaderExport: document.getElementById('btnHeaderExport'),
            footerExport: document.getElementById('footerExport'),
            chartTitle: document.getElementById('chartTitle'),
            chartSubtitle: document.getElementById('chartSubtitle'),
            metricsRow: document.getElementById('metricsRow'),
            reportChart: document.getElementById('reportChart'),
            tableHead: document.getElementById('tableHead'),
            tableBody: document.getElementById('tableBody'),
            tableSearch: document.getElementById('tableSearch'),
            rowsPerPage: document.getElementById('rowsPerPage'),
            paginationInfo: document.getElementById('paginationInfo'),
            pagination: document.getElementById('pagination'),
            toastArea: document.getElementById('toastArea')
        };

        // Flatpickr week picker configuration (past weeks only)
        const fp = flatpickr(el.weekPicker, {
            altInput: true,
            altFormat: 'M j, Y',
            dateFormat: 'Y-m-d',
            maxDate: new Date(),
            plugins: [new weekSelect({})],
            onChange: (selectedDates) => {
                if (selectedDates && selectedDates.length) {
                    const dt = selectedDates[0];
                    const range = getWeekRange(dt);
                    state.selectedWeek = range;
                } else {
                    state.selectedWeek = null;
                }
                validateFilters();
            }
        });

        // Quick-week from header dropdown
        document.querySelectorAll('.js-quick-week').forEach(item => {
            item.addEventListener('click', (e) => {
                const val = e.currentTarget.getAttribute('data-range');
                const today = new Date();
                let ref = new Date(today);
                if (val === 'last') {
                    ref.setDate(ref.getDate() - 7);
                }
                const range = getWeekRange(ref);
                // Set flatpickr to date inside the desired week
                fp.setDate(range.start, true);
            });
        });

        // Filter event handlers
        el.reportType.addEventListener('change', () => {
            state.selectedReportType = el.reportType.value;
            validateFilters();
        });

        el.btnReset.addEventListener('click', () => {
            el.reportType.value = '';
            state.selectedReportType = '';
            fp.clear();
            state.selectedWeek = null;
            validateFilters();
        });

        el.btnGenerate.addEventListener('click', async () => {
            if (!state.selectedReportType || !state.selectedWeek) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Incomplete filters',
                    text: 'Please select both report type and week.'
                });
                return;
            }
            try {
                setLoading(true);
                const data = await fetchReportData(state.selectedReportType, state.selectedWeek);
                state.reportData = data;
                renderReport();
                // setLoading(false);
                state.isReportGenerated = true;
                el.btnExport.disabled = false;
                showToast('Report generated successfully');
            } catch (err) {
                setLoading(false);
                console.error(err);

                // Check if the error status is 401 (Unauthorized) or 403 (Forbidden)
                if (err.status === 401 || err.status === 403) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Unauthorised Access',
                        text: 'Login with an admin ID to generate this report.'
                    });
                } else {
                    // For all other errors (like server down), show the generic message
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed to generate',
                        text: 'An error occurred while generating the report. Please try again.'
                    });
                }
            }
        });

        // Export handlers (header, in-card, footer)
        [el.btnExport, el.btnHeaderExport, el.footerExport].forEach(btn => {
            btn?.addEventListener('click', (e) => {
                e.preventDefault();
                if (!state.isReportGenerated) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No report yet',
                        text: 'Generate a report first to export.'
                    });
                    return;
                }
                exportPDF();
            });
        });

        // Table interactions
        el.tableSearch.addEventListener('input', () => {
            applyTableFilter(el.tableSearch.value.trim());
        });
        el.rowsPerPage.addEventListener('change', () => {
            state.table.rowsPerPage = parseInt(el.rowsPerPage.value, 10);
            state.table.page = 1;
            renderTable();
        });

        // Utilities
        function validateFilters() {
            const ok = !!state.selectedReportType && !!state.selectedWeek;
            el.btnGenerate.disabled = !ok;
        }

        function setLoading(flag) {
            state.isLoading = flag;
            el.btnGenerate.disabled = flag || !state.selectedReportType || !state.selectedWeek;
            el.genSpinner.classList.toggle('d-none', !flag);
            el.emptyState.classList.toggle('d-none', flag);
            el.loadingState.classList.toggle('d-none', !flag);
            el.reportContent.classList.toggle('d-none', true);
        }

        function getWeekRange(date) {
            // Calculate Monday-Sunday range for the given date
            const d = new Date(date);
            const day = d.getDay(); // 0 = Sun, 1 = Mon, ...
            const diffToMonday = (day === 0 ? -6 : 1) - day; // shift to Monday
            const start = new Date(d);
            start.setDate(d.getDate() + diffToMonday);
            start.setHours(0, 0, 0, 0);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            return {
                start,
                end
            };
        }

        function formatDate(d) {
            return d.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat(undefined, {
                style: 'currency',
                currency: 'USD'
            }).format(num);
        }

        function formatPercent(num) {
            return `${(num).toFixed(0)}%`;
        }

        function showToast(message) {
            el.toastArea.querySelector('.toast-body').textContent = message;
            const t = new bootstrap.Toast(el.toastArea, {
                delay: 2500
            });
            t.show();
        }

        // REPLACE your old fetchReportData function with this one.

        async function fetchReportData(type, { start, end }) {
            // Format dates into ISO strings, which the backend API expects
            const params = new URLSearchParams({
                start_date: start.toISOString(),
                end_date: end.toISOString()
            });

            if (type === 'Weekly Revenue') {
                // Call the revenue report endpoint
                const apiData = await fetchWithAuth(`/admin/reports/revenue?${params.toString()}`);
                // The API data needs to be transformed to match what the UI expects
                return transformRevenueData(apiData);
            }

            if (type === 'Weekly Occupancy') {
                // Call the occupancy report endpoint
                const apiData = await fetchWithAuth(`/admin/reports/occupancy?${params.toString()}`);
                // Transform the data to fit the UI
                return transformOccupancyData(apiData);
            }

            // Fallback for unknown report types
            throw new Error(`Unknown report type: ${type}`);
        }

        // ADD these two new helper functions to your script

        function transformRevenueData(apiData) {
            // This function converts the API response into the format the frontend needs
            return {
                type: 'Weekly Revenue',
                start: new Date(apiData.report_period.start_date),
                end: new Date(apiData.report_period.end_date),
                revenueFromPenalties: apiData.revenue_from_penalties,
                summary: {
                    totalRevenue: apiData.total_revenue,
                    totalTransactions: 0, // API doesn't provide this, so we use a placeholder
                    averageTicket: 0,     // Placeholder
                    lotsCount: Object.keys(apiData.revenue_by_lot).length
                },
                chart: {
                    labels: Object.keys(apiData.revenue_by_lot),
                    datasets: [{
                        label: 'Revenue by Lot (₹)',
                        data: Object.values(apiData.revenue_by_lot),
                        backgroundColor: 'rgba(0,153,210,0.35)',
                        borderColor: 'rgba(0,153,210,1)',
                        borderWidth: 2
                    }]
                },
                table: {
                    columns: [
                        { key: 'method', label: 'Payment Method', type: 'text' },
                        { key: 'revenue', label: 'Revenue', type: 'currency' }
                    ],
                    rows: Object.entries(apiData.revenue_by_payment_method).map(([method, revenue]) => ({ method, revenue }))
                }
            };
        }


        function transformOccupancyData(apiData) {
            // This function converts the API response into the format the frontend needs
            return {
                type: 'Weekly Occupancy',
                start: new Date(apiData.report_period.start_date),
                end: new Date(apiData.report_period.end_date),
                summary: {
                    avgOccupancy: 0, // Placeholder, as this requires more complex calculation
                    peakOccupancy: Math.max(...Object.values(apiData.peak_hours_data)), // Peak is the max count in any hour
                    lotsCount: Object.keys(apiData.occupancy_by_lot).length,
                    daysCount: 7 // Assuming weekly
                },
                chart: {
                    labels: Object.keys(apiData.peak_hours_data).map(hour => `${hour}:00`),
                    datasets: [{
                        label: 'Peak Hour Vehicle Count',
                        data: Object.values(apiData.peak_hours_data),
                        backgroundColor: 'rgba(0,119,78,0.25)',
                        borderColor: 'rgba(0,119,78,1)',
                        borderWidth: 2,
                        tension: 0.25,
                        fill: true
                    }]
                },
                table: {
                    columns: [
                        { key: 'type', label: 'Vehicle Type', type: 'text' },
                        { key: 'duration', label: 'Avg. Duration (mins)', type: 'number' }
                    ],
                    rows: Object.entries(apiData.average_duration_by_vehicle_type).map(([type, duration]) => ({ type, duration }))
                }
            };
        }

        function renderReport() {
            const d = state.reportData;
            // Titles and badges
            const title = `${d.type} Report: ${formatDate(d.start)} - ${formatDate(d.end)}`;
            el.reportTitle.textContent = title;
            el.reportSubtitle.textContent = 'Generated for selected period and criteria';
            el.badgeWeek.textContent = `${formatDate(d.start)} – ${formatDate(d.end)}`;
            el.badgeType.innerHTML = `<i class="fa-solid fa-layer-group me-1"></i>${d.type}`;

            // Metrics
            renderMetrics(d);

            // Chart
            renderChart(d);

            // Table
            state.table.columns = d.table.columns;
            state.table.rows = d.table.rows;
            state.table.filteredRows = [...state.table.rows];
            state.table.page = 1;
            el.tableSearch.value = '';
            el.rowsPerPage.value = '10';
            state.table.rowsPerPage = 10;
            renderTable();

            // Toggle sections
            el.loadingState.classList.add('d-none');
            el.emptyState.classList.add('d-none');
            el.reportContent.classList.remove('d-none');

            // Chart header details
            el.chartTitle.textContent = d.type === 'Weekly Revenue' ? 'Revenue by Day' : 'Average Occupancy by Day';
            el.chartSubtitle.textContent = 'Use mouse wheel or pinch to zoom; drag to pan. Double-click to reset.';
            if (d.type === 'Weekly Revenue') {
                const penaltiesSection = document.getElementById('penalties');
                const penaltiesTotalEl = penaltiesSection.querySelector('#penaltiesTotalAmount');
                // Use your currency formatting function
                penaltiesTotalEl.textContent = formatCurrency(d.revenueFromPenalties);
                penaltiesSection.classList.remove('d-none');
            }
        }

        function renderMetrics(d) {
            const m = d.summary;
            const cards = [];
            if (d.type === 'Weekly Revenue') {
                cards.push(metricCard('Total Revenue', formatCurrency(m.totalRevenue), 'fa-sack-dollar', 'info'));
                cards.push(metricCard('Total Transactions', m.totalTransactions.toLocaleString(), 'fa-receipt', 'success'));
                cards.push(metricCard('Average Ticket', formatCurrency(m.averageTicket), 'fa-ticket', 'secondary'));
                cards.push(metricCard('Lots Covered', m.lotsCount, 'fa-square-parking', 'primary'));
            } else {
                cards.push(metricCard('Avg Occupancy', formatPercent(m.avgOccupancy), 'fa-chart-area', 'success'));
                cards.push(metricCard('Peak Occupancy', formatPercent(m.peakOccupancy), 'fa-chart-line', 'warning'));
                cards.push(metricCard('Lots Covered', m.lotsCount, 'fa-square-parking', 'info'));
                cards.push(metricCard('Days in Range', m.daysCount, 'fa-calendar-day', 'secondary'));
            }
            el.metricsRow.innerHTML = cards.join('');
        }

        function metricCard(title, value, icon, tone) {
            return `
        <div class="metric-card">
          <div class="metric-title">${title}</div>
          <div class="d-flex align-items-center justify-content-between">
            <div class="metric-value">${value}</div>
            <div class="badge-soft ${tone}"><i class="fa-solid ${icon}"></i></div>
          </div>
        </div>`;
        }

        function renderChart(d) {
            if (state.chart) {
                state.chart.destroy();
            }
            const ctx = el.reportChart.getContext('2d');
            const config = {
                type: d.type === 'Weekly Revenue' ? 'bar' : 'line',
                data: {
                    labels: d.chart.labels,
                    datasets: d.chart.datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            enabled: true
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (val) => d.type === 'Weekly Revenue' ? formatCurrency(val) : `${val}%`
                            }
                        }
                    },
                    onDblClick: (e, item) => {
                        state.chart.resetZoom();
                    }
                }
            };
            state.chart = new Chart(ctx, config);
            // Reset zoom on double-click (fallback handler)
            el.reportChart.addEventListener('dblclick', () => state.chart.resetZoom());
        }

        function applyTableFilter(term) {
            const t = term.toLowerCase();
            if (!t) {
                state.table.filteredRows = [...state.table.rows];
            } else {
                state.table.filteredRows = state.table.rows.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(t)));
            }
            state.table.page = 1;
            renderTable();
        }

        function renderTable() {
            // Head with sort controls
            el.tableHead.innerHTML = `<tr>${state.table.columns.map(c => `
        <th role="button" class="sortable" data-key="${c.key}">
          <span>${c.label}</span>
          <i class="sort-indicator fa-solid fa-arrow-down-short-wide ms-2 text-muted"></i>
        </th>`).join('')}</tr>`;

            el.tableHead.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.getAttribute('data-key');
                    if (state.table.sortKey === key) {
                        state.table.sortDir = state.table.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.table.sortKey = key;
                        state.table.sortDir = 'asc';
                    }
                    sortTable();
                    renderTable();
                });
            });

            // Sort indicator update
            el.tableHead.querySelectorAll('th.sortable').forEach(th => {
                const key = th.getAttribute('data-key');
                const icon = th.querySelector('.sort-indicator');
                if (key === state.table.sortKey) {
                    icon.classList.remove('fa-arrow-down-short-wide', 'fa-arrow-up-short-wide');
                    icon.classList.add(state.table.sortDir === 'asc' ? 'fa-arrow-down-short-wide' : 'fa-arrow-up-short-wide');
                    icon.classList.remove('text-muted');
                } else {
                    icon.classList.add('text-muted');
                }
            });

            // Pagination and rows
            const total = state.table.filteredRows.length;
            const per = state.table.rowsPerPage;
            const pages = Math.max(1, Math.ceil(total / per));
            if (state.table.page > pages) state.table.page = pages;
            const startIdx = (state.table.page - 1) * per;
            const endIdx = Math.min(startIdx + per, total);
            const pageRows = state.table.filteredRows.slice(startIdx, endIdx);

            // Rows
            el.tableBody.innerHTML = pageRows.map(r => `<tr>
        ${state.table.columns.map(c => `<td>${formatCell(r[c.key], c.type)}</td>`).join('')}
      </tr>`).join('');

            el.paginationInfo.textContent = total === 0 ? 'Showing 0 to 0 of 0 entries' : `Showing ${startIdx + 1} to ${endIdx} of ${total} entries`;

            // Pagination controls
            el.pagination.innerHTML = '';
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${state.table.page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (state.table.page > 1) {
                    state.table.page--;
                    renderTable();
                }
            });
            el.pagination.appendChild(prevLi);

            for (let p = 1; p <= pages; p++) {
                const li = document.createElement('li');
                li.className = `page-item ${p === state.table.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${p}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.table.page = p;
                    renderTable();
                });
                el.pagination.appendChild(li);
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${state.table.page === pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (state.table.page < pages) {
                    state.table.page++;
                    renderTable();
                }
            });
            el.pagination.appendChild(nextLi);
        }

        function formatCell(val, type) {
            switch (type) {
                case 'currency':
                    return formatCurrency(val);
                case 'number':
                    return Number(val).toLocaleString();
                case 'percent':
                    return formatPercent(Number(val));
                case 'date':
                    return val; // already formatted date string
                default:
                    return val;
            }
        }

        function sortTable() {
            const {
                sortKey,
                sortDir
            } = state.table;
            if (!sortKey) return;
            const colType = (state.table.columns.find(c => c.key === sortKey) || {}).type || 'text';
            state.table.filteredRows.sort((a, b) => {
                let va = a[sortKey],
                    vb = b[sortKey];
                if (colType === 'currency' || colType === 'number' || colType === 'percent') {
                    va = Number(String(va).toString().replace(/[^0-9.-]/g, ''));
                    vb = Number(String(vb).toString().replace(/[^0-9.-]/g, ''));
                } else if (colType === 'date') {
                    va = new Date(va);
                    vb = new Date(vb);
                } else {
                    va = String(va).toLowerCase();
                    vb = String(vb).toLowerCase();
                }
                if (va < vb) return sortDir === 'asc' ? -1 : 1;
                if (va > vb) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // REPLACE your old exportPDF function with this new version

        // REPLACE your old exportPDF function with this new version

        function exportPDF() {
            // 1. Check if a report has been generated
            if (!state.isReportGenerated || !state.reportData) {
                Swal.fire({
                    icon: 'info',
                    title: 'No Report Generated',
                    text: 'Please generate a report before exporting.'
                });
                return;
            }

            const elementToExport = document.querySelector('.report-section:not(.d-none)');

            if (!elementToExport) {
                Swal.fire('Error', 'Could not find the report content to export.', 'error');
                return;
            }

            const fileName = `${elementToExport.id}-report.pdf`;
            const opt = {
                margin: 10,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            Swal.fire({ title: 'Generating PDF...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            // --- FIX: Temporarily disable chart animations ---
            Chart.defaults.animation = false;

            html2pdf().set(opt).from(elementToExport).save().then(() => {
                // --- Re-enable animations after PDF is saved ---
                Chart.defaults.animation = true;
                Swal.close();
            });
        }
        document.addEventListener('DOMContentLoaded', function () {

            // Find the logout button by the ID we just added
            const logoutButton = document.getElementById('logoutButton');

            // Check if the logout button exists on this page
            if (logoutButton) {

                // Add an event listener to run code when it's clicked
                logoutButton.addEventListener('click', function (event) {

                    // Prevent the link's default behavior (which is to go to "#")
                    event.preventDefault();

                    console.log('Logout button clicked. Clearing session...');

                    // 1. Remove the access token from Local Storage
                    localStorage.removeItem('accessToken');

                    // 2. (Optional but recommended) Alert the user
                    alert('You have been successfully logged out.');

                    // 3. Redirect to the login page
                    window.location.href = './index.html';
                });
            }
        });
        // This script should be placed in a <script> tag on pages where the modal exists
        document.addEventListener('DOMContentLoaded', function () {
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            if (sendMessageBtn) {
                sendMessageBtn.addEventListener('click', function () {
                    // In a real app, you would gather form data and send it to your server here.
                    // Example: const name = document.getElementById('contactName').value;

                    // For now, we'll just show a success message.
                    Swal.fire({
                        icon: 'success',
                        title: 'Message Sent!',
                        text: 'Thank you for contacting us. We will get back to you shortly.',
                        timer: 2500,
                        showConfirmButton: false
                    });

                    // Close the modal
                    const contactModal = document.getElementById('contactModal');
                    const modal = bootstrap.Modal.getInstance(contactModal);
                    if (modal) {
                        modal.hide();
                    }
                });
            }
        });
        // Nothing to render yet
    </script>
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel"><i class="fa-solid fa-paper-plane me-2"></i>Contact
                        Support</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">If you have any questions or need assistance, please fill out the form
                        below. Our team will get back to you shortly.</p>
                    <form id="contactForm">
                        <div class="mb-3">
                            <label for="contactName" class="form-label">Your Name</label>
                            <input type="text" class="form-control" id="contactName" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Your Email</label>
                            <input type="email" class="form-control" id="contactEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="contactMessage" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="sendMessageBtn">Send Message</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>